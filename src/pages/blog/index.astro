---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import FormattedDate from '../../components/FormattedDate.astro';
import { onMount } from 'astro/client';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

let firestorePosts = [];
if (typeof window === 'undefined') {
  // SSR: fetch Firestore posts from the API
  try {
    const res = await fetch(`${import.meta.env.SITE || ''}/api/get-posts`);
    if (res.ok) {
      firestorePosts = await res.json();
    }
  } catch (e) {
    firestorePosts = [];
  }
}
---

<Layout title="MyBlog - All Posts">
	<section class="py-20 px-4 sm:px-6 max-w-4xl mx-auto flex justify-end">
		<a href="/blog/new" class="inline-flex items-center bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
			<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
				<path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
			</svg>
			Add New Blog
		</a>
	</section>
	<section class="py-20 px-4 sm:px-6 max-w-4xl mx-auto">
		<h1 class="text-4xl font-bold text-slate-900 dark:text-white mb-12">All Blog Posts</h1>
		<div class="grid gap-10 md:grid-cols-2">
			{[...firestorePosts, ...posts].map((post) => (
				<article class="group relative flex flex-col bg-white dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-2xl overflow-hidden hover:shadow-lg transition-shadow duration-300">
					<a href={post.slug ? `/blog/${post.slug}/` : '#'} class="block aspect-video overflow-hidden">
						<img 
							src={post.data?.heroImage || post.heroImage || 'https://placehold.co/600x400/png'} 
							alt="" 
							class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
						/>
					</a>
					<div class="p-6 flex flex-col flex-grow">
						<div class="flex items-center gap-3 text-sm text-slate-500 dark:text-slate-400 mb-3">
							<FormattedDate date={post.data?.pubDate || post.createdAt} />
							<span class="w-1 h-1 bg-slate-300 rounded-full"></span>
							<span class="text-primary-500 font-medium">{post.data?.category || post.category}</span>
						</div>
						<h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-2 group-hover:text-primary-500 transition-colors">
							<a href={post.slug ? `/blog/${post.slug}/` : '#'}>
								{post.data?.title || post.title}
							</a>
						</h3>
						<p class="text-slate-600 dark:text-slate-300 line-clamp-3 mb-4 flex-grow">
							{post.data?.description || post.content?.slice(0, 120) || ''}
						</p>
						<a href={post.slug ? `/blog/${post.slug}/` : '#'} class="inline-flex items-center text-primary-600 dark:text-primary-400 font-medium hover:text-primary-700 dark:hover:text-primary-300">
							Read Article
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1">
								<path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
							</svg>
						</a>
					</div>
				</article>
			))}
		</div>
	</section>
</Layout>
